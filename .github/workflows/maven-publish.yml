name: CodeQL Security Report

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  analyze:
    name: Generate Security Report
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read

    steps:
      # 步骤1：检出代码
      - uses: actions/checkout@v4

      # 步骤2：初始化 CodeQL（仅扫描 Java）
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: 'java'
          queries: security-extended

      # 步骤3：编译项目（必须步骤）
      - name: Build with Maven
        run: mvn clean package -DskipTests

      # 步骤4：运行分析（输出到固定目录）
      - name: Run CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          output: ./codeql_results

      # 步骤5：生成人性化报告（无需额外依赖）
      - name: Create Security Report
        run: |
          # 创建报告目录
          mkdir -p reports
          
          # 生成Markdown主报告
          echo "# 安全扫描报告" > reports/security-report.md
          echo "**扫描时间**: $(date '+%Y-%m-%d %H:%M:%S')" >> reports/security-report.md
          echo "\n## 漏洞概览" >> reports/security-report.md
          
          # 从SARIF文件提取数据
          jq -r '
            .runs[0].results | 
            group_by(.level) | 
            map("• **\(.[0].level | ascii_upcase)**: \(length)个") | 
            join("\n")
          ' ./codeql_results/results.sarif >> reports/security-report.md

          # 添加详细问题列表
          echo "\n## 问题详情" >> reports/security-report.md
          jq -r '
            .runs[0].results[] | 
            "### \(.ruleId)\n" +
            "**文件**: `\(.locations[0].physicalLocation.artifactLocation.uri)` " +
            "(行: \(.locations[0].physicalLocation.region.startLine))\n" +
            "**严重性**: \(.level)\n" +
            "**描述**: \(.message.text)\n"
          ' ./codeql_results/results.sarif >> reports/security-report.md

      # 步骤6：上传报告（自动打包）
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: |
            reports/security-report.md
            ./codeql_results/results.sarif