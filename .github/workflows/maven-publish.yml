name: CodeQL Analysis with Report

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  analyze:
    name: Analyze with CodeQL
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      # 初始化 CodeQL
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: 'java'
          queries: +security-extended

      # 编译项目
      - name: Build project
        run: mvn clean package -DskipTests

      # CodeQL 分析（输出 SARIF 文件）
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: 'java-security'
          output: codeql-results # 指定输出目录

      # ========== 新增报告生成步骤 ==========
      - name: Setup Report Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq chromium
          npm install -g @microsoft/sarif-viewer

      # 生成 HTML 报告（交互式）
      - name: Generate HTML Report
        run: |
          npx sarif-viewer --input ./codeql-results/results.sarif \
                          --output ./codeql-report.html \
                          --title "CodeQL Security Report"

      # 生成 PDF 报告（适合打印）
      - name: Generate PDF Report
        run: |
          npx sarif-viewer --input ./codeql-results/results.sarif \
                          --output ./codeql-report.pdf \
                          --format pdf

      # 生成 Markdown 摘要（快速预览）
      - name: Generate Summary
        run: |
          echo "# CodeQL 安全扫描报告" > report.md
          echo "**扫描时间**: $(date '+%Y-%m-%d %H:%M:%S')" >> report.md
          echo "\n## 漏洞统计" >> report.md
          jq -r '.runs[0].results | group_by(.level) | map("• \(.[0].level | ascii_upcase): \(length)个") | join("\n")' ./codeql-results/results.sarif >> report.md
          echo "\n## 严重问题示例" >> report.md
          jq -r '.runs[0].results[] | select(.level == "error") | "- [\(.ruleId)] \(.message.text)\n  文件: \(.locations[0].physicalLocation.artifactLocation.uri):\(.locations[0].physicalLocation.region.startLine)"' ./codeql-results/results.sarif | head -5 >> report.md

      # 上传所有报告文件
      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            ./codeql-report.html
            ./codeql-report.pdf
            ./report.md