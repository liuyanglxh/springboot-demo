name: CodeQL Analysis with Report

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  analyze:
    name: Analyze with CodeQL
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      # 初始化 CodeQL
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: 'java'
          queries: +security-extended

      # 编译项目
      - name: Build project
        run: mvn clean package -DskipTests

      # CodeQL 分析
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: 'java-security'
          output: codeql-results

      # ========== 报告生成 ==========
      - name: Setup Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          npm install -g @microsoft/sarif-tools

      # 生成HTML报告
      - name: Generate HTML Report
        run: |
          npx @microsoft/sarif-tools sarif2html \
            --input ./codeql-results/results.sarif \
            --output ./codeql-report.html \
            --dark

      # 生成Markdown摘要
      - name: Generate Summary
        run: |
          echo "# CodeQL 安全扫描报告" > report.md
          echo "**扫描时间**: $(date '+%Y-%m-%d %H:%M:%S')" >> report.md
          echo "\n## 漏洞统计" >> report.md
          jq -r '.runs[0].results | group_by(.level) | map("• \(.[0].level | ascii_upcase): \(length)个") | join("\n")' ./codeql-results/results.sarif >> report.md
          echo "\n## 严重问题示例" >> report.md
          jq -r '.runs[0].results[] | select(.level == "error") | "- [\(.ruleId)] \(.message.text)\n  文件: \(.locations[0].physicalLocation.artifactLocation.uri):\(.locations[0].physicalLocation.region.startLine)"' ./codeql-results/results.sarif | head -5 >> report.md

      # 上传报告
      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            ./codeql-report.html
            ./report.md