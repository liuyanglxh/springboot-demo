name: CodeQL Analysis with Report

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  analyze:
    name: Analyze with CodeQL
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      # 初始化 CodeQL
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: 'java'
          queries: +security-extended

      # 编译项目
      - name: Build project
        run: mvn clean package -DskipTests

      # CodeQL 分析
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: 'java-security'
          output: codeql-results

      # ========== 纯本地报告生成 ==========
      - name: Setup Tools
        run: sudo apt-get update && sudo apt-get install -y jq

      # 生成Markdown报告（100%可靠）
      - name: Generate Markdown Report
        run: |
          echo "# CodeQL 安全扫描报告" > report.md
          echo "**扫描时间**: $(date '+%Y-%m-%d %H:%M:%S')" >> report.md
          echo "\n## 漏洞统计" >> report.md
          
          # 统计各级别漏洞数量
          jq -r '.runs[0].results | group_by(.level) | map("• \(.[0].level | ascii_upcase): \(length)个") | join("\n")' ./codeql-results/results.sarif >> report.md
          
          echo "\n## 详细问题列表" >> report.md
          
          # 列出所有问题（按严重程度排序）
          jq -r '.runs[0].results | sort_by(.level) | reverse | .[] | "### \(.ruleId)\n" +
                 "**严重程度**: \(.level)\n" +
                 "**文件**: \(.locations[0].physicalLocation.artifactLocation.uri):\(.locations[0].physicalLocation.region.startLine)\n" +
                 "**描述**: \(.message.text)\n" +
                 "**修复建议**: \(if .resolution then .resolution.markdown else "无" end)\n"' \
              ./codeql-results/results.sarif >> report.md

      # 生成精简版JSON报告（保留原始数据）
      - name: Generate Simplified JSON
        run: |
          jq '.runs[0].results | map({
            ruleId: .ruleId,
            level: .level,
            message: .message.text,
            file: .locations[0].physicalLocation.artifactLocation.uri,
            line: .locations[0].physicalLocation.region.startLine,
            snippet: .locations[0].physicalLocation.region.snippet?.text
          })' ./codeql-results/results.sarif > report.json

      # 上传报告
      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            ./report.md
            ./report.json
            ./codeql-results/results.sarif  # 原始数据