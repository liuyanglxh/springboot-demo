name: CodeQL Security Report

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  analyze:
    name: Generate Security Report
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read

    steps:
      # 步骤1：检出代码
      - uses: actions/checkout@v4

      # 步骤2：初始化 CodeQL
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: 'java'
          queries: security-extended

      # 步骤3：编译项目
      - name: Build with Maven
        run: mvn clean package -DskipTests

      # 步骤4：运行分析（带错误处理）
      - name: Run CodeQL Analysis
        id: codeql-analysis
        uses: github/codeql-action/analyze@v2
        continue-on-error: true  # 即使分析失败也继续
        with:
          output: ./codeql_results

      # 步骤5：验证结果文件
      - name: Check SARIF File
        id: check-sarif
        run: |
          if [ -f "./codeql_results/results.sarif" ]; then
            echo "sarif_exists=true" >> $GITHUB_OUTPUT
            echo "::notice::SARIF file found, proceeding with report generation"
          else
            echo "sarif_exists=false" >> $GITHUB_OUTPUT
            echo "::warning::No SARIF file found at ./codeql_results/results.sarif"
            # 调试：列出目录内容
            echo "Directory contents:"
            ls -la ./codeql_results/ || echo "No codeql_results directory"
          fi

      # 步骤6：生成报告（仅当有结果时）
      - name: Create Security Report
        if: steps.check-sarif.outputs.sarif_exists == 'true'
        run: |
          mkdir -p reports
          
          # 基础报告
          echo "# 安全扫描报告" > reports/security-report.md
          echo "**扫描时间**: $(date '+%Y-%m-%d %H:%M:%S')" >> reports/security-report.md
          
          # 使用jq处理SARIF文件
          {
            echo "## 漏洞概览"
            jq -r '
              .runs[0].results | 
              if length > 0 then
                group_by(.level) | 
                map("• \(.[0].level | ascii_upcase): \(length)个") | 
                join("\n")
              else
                "未发现安全问题"
              end
            ' ./codeql_results/results.sarif
          
            echo "\n## 详细结果"
            jq -r '
              .runs[0].results | 
              if length > 0 then
                .[] | 
                "### \(.ruleId)\n" +
                "**文件**: `\(.locations[0].physicalLocation.artifactLocation.uri)` " +
                "(行: \(.locations[0].physicalLocation.region.startLine))\n" +
                "**严重性**: \(.level)\n" +
                "**描述**: \(.message.text)\n"
              else
                "无漏洞报告"
              end
            ' ./codeql_results/results.sarif
          } >> reports/security-report.md

      # 步骤7：上传结果（无论成功与否）
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: |
            reports/security-report.md
            ./codeql_results/results.sarif
          if-no-files-found: warn  # 没有文件时不报错